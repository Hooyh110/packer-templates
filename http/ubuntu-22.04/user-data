#cloud-config
autoinstall:
  version: 1
  identity:
    hostname: packer
    username: osuadmin
    # Generated via: printf osuadmin | mkpasswd -m sha-512 -S osuadmin. -s
    password: "$6$osuadmin.$QXNHxHGhDBX1KStyKri0uqdkSObBtjUUzj31IPU1TkMl.uUu0HwB365HSm5za6bVhDoSpTvVLqjKOzKjQMCxL/"
  keyboard:
    layout: us
    toggle: null
    variant: intl
  locale: en_US.UTF-8
  network:
    version: 2
    renderer: networkd
    ethernets:
      ens3:
        dhcp4: true
        dhcp6: false
        nameserver:
          addresses:
            - 8.8.8.8
            - 8.8.4.4
  storage:
    config:
      - type: disk
        match:
          name: vda
        preserve: false
        wipe: superblock-recursive
        ptable: gpt
        name: primary
        grub_device: true
        wipe_table: true
        part:
          - size: 512M
            number: 1
            flags:
              - boot
            type: efi
          - size: 2G
            number: 2
            type: swap
          - size: 0
            number: 3
            type: ext4
            wipe_filesystem: true
            growfs_on_boot: true 
  
  early-commands:
    # otherwise packer tries to connect and exceed max attempts:
    - systemctl stop ssh
    - systemctl restart systemd-timesyncd
  late-commands:
    - curtin in-target -- apt-get update
    - curtin in-target -- apt-get -y install qemu-guest-agent
    - echo "PermitRootLogin yes" >> /target/etc/ssh/sshd_config
    - curtin in-target --target=/target -- passwd -q -u root
    - curtin in-target --target=/target -- passwd -q -x -1 root
    - sed -i 's|^root:.:|root:$6$osuadmin.$QXNHxHGhDBX1KStyKri0uqdkSObBtjUUzj31IPU1TkMl.uUu0HwB365HSm5za6bVhDoSpTvVLqjKOzKjQMCxL/:|' /target/etc/shadow
    - curtin in-target --target=/target -- apt-get -y dist-upgrade
  ssh:
    install-server: true
  refresh-installer:
    update: yes
  packages:
    - openssh-server
    - cloud-init
    - cloud-initramfs-growroot
    - cloud-initramfs-copymods
    - cloud-initramfs-dyn-netconf
    - cloud-initramfs-root-fs
    - cloud-initramfs-shutdown
    - cloud-initramfs-sysctls
    - cloud-initramfs-upgrade
    - cloud-initramfs-unmount
    - cloud-initramfs-boot-cleanup
    - cloud-initramfs-boot-cleanup.service
    - cloud-initramfs-boot-cleanup.timer
    - htop
    - vim
    - git
    - python3
    - python3-pip
    - python3-venv
    - python3-dev
    - net-tools
    - iputils-ping
    - iputils-tracepath
    - traceroute
    - dnsutils
    - nmap
    - curl
    - wget
    - lsb-release
    - software-properties-common
    - apt-transport-https
    - ca-certificates
    - gnupg
    - apt-utils
    - python3-apt
    - python3-setuptools
    - python3-pkg-resources
    - python3-requests
    - python3-urllib3
    - python3-httplib2
    - python3-oauth2client
    - python3-pycurl
    - python3-requests-oauthlib
    - python3-requests-unixsocket
    - python3-requests-toolbelt
    - python3-cryptography
    - python3-cryptography-vectors  
  apt:
    preserve_sources_list: false
    primary:
     - arches: [i386, amd64]
       uri: "http://mirrors.aliyun.com/ubuntu/"
     - arches: [default]
       uri: "http://mirrors.aliyun.com/ubuntu/"
    geoip: false
