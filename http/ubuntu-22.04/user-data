#cloud-config
autoinstall:
  version: 1
  identity:
    hostname: packer
    username: osuadmin
    # Generated via: printf osuadmin | mkpasswd -m sha-512 -S osuadmin. -s
    password: "$6$osuadmin.$QXNHxHGhDBX1KStyKri0uqdkSObBtjUUzj31IPU1TkMl.uUu0HwB365HSm5za6bVhDoSpTvVLqjKOzKjQMCxL/"
  keyboard:
    layout: us
    toggle: null
    variant: ""
  locale: en_US.UTF-8
  timezone: Asia/Shanghai
  network:
    version: 2
    renderer: networkd
    ethernets: {}
  # network:
  #   version: 2
  #   renderer: networkd
  #   ethernets:
  #     ens3:
  #       dhcp4: true
  #       dhcp6: false
  #       nameserver:
  #         addresses:
  #           - 8.8.8.8
  #           - 8.8.4.4
  # source:
  #   id: ubuntu-22.04
  #   search_drivers: false
  ssh:
    allow-pw: true
    authorized-keys: []
    install-server: true
  storage:
    config:
      - ptable: gpt
        path: /dev/vda
        wipe: superblock-recursive
        preserve: false
        name: ""
        grub_device: false
        type: disk
        id: disk-sda
      - device: disk-sda
        size: 1127219200
        wipe: superblock
        flag: boot
        number: 1
        preserve: false
        grub_device: true
        offset: 1048576
        type: partition
        id: partition-0
      - fstype: fat32
        volume: partition-0
        preserve: false
        type: format
        id: format-0
      - device: disk-sda
        size: 2147483648
        wipe: superblock
        number: 2
        preserve: false
        grub_device: false
        offset: 1128267776
        type: partition
        id: partition-1
      - fstype: ext4
        volume: partition-1
        preserve: false
        type: format
        id: format-1
      - device: disk-sda
        size: -1 #2395999305728
        wipe: superblock
        number: 3
        preserve: false
        grub_device: false
        offset: 3275751424
        type: partition
        id: partition-2
      - name: ubuntu-vg
        devices:
          - partition-2
        preserve: false
        type: lvm_volgroup
        id: lvm_volgroup-0
      - name: ubuntu-lv
        volgroup: lvm_volgroup-0
        # size: 2395996160000B
        wipe: superblock
        preserve: false
        type: lvm_partition
        id: lvm_partition-0
      - fstype: xfs
        volume: lvm_partition-0
        preserve: false
        type: format
        id: format-3
      - path: /
        device: format-3
        type: mount
        id: mount-3
      - path: /boot
        device: format-1
        type: mount
        id: mount-1
      - path: /boot/efi
        device: format-0
        type: mount
        id: mount-0
  # early-commands:
  #   # otherwise packer tries to connect and exceed max attempts:
  #   - systemctl stop ssh
  #   - systemctl restart systemd-timesyncd
  late-commands:
    - mkdir -p /etc/apt/keyrings
    - cp /path/to/your/certificate.crt /etc/apt/keyrings/
    - echo "Acquire::https::mirrors.aliyun.com::Verify-Peer \"false\";" > /etc/apt/apt.conf.d/99disable-ssl-verification
    - curtin in-target -- apt-get update
    - curtin in-target -- apt-get -y install qemu-guest-agent
    - echo "PermitRootLogin yes" >> /target/etc/ssh/sshd_config
    - curtin in-target --target=/target -- passwd -q -u root
    - curtin in-target --target=/target -- passwd -q -x -1 root
    - sed -i 's|^root:.:|root:$6$osuadmin.$QXNHxHGhDBX1KStyKri0uqdkSObBtjUUzj31IPU1TkMl.uUu0HwB365HSm5za6bVhDoSpTvVLqjKOzKjQMCxL/:|' /target/etc/shadow
    - curtin in-target --target=/target -- apt-get -y dist-upgrade
  # ssh:
  #   install-server: true
  refresh-installer:
    update: yes
  packages:
    - openssh-server
    - cloud-init
    - cloud-initramfs-growroot
    - cloud-initramfs-copymods
    - cloud-initramfs-dyn-netconf
    - cloud-initramfs-root-fs
    - cloud-initramfs-shutdown
    - cloud-initramfs-sysctls
    - cloud-initramfs-upgrade
    - cloud-initramfs-unmount
    - cloud-initramfs-boot-cleanup
    - cloud-initramfs-boot-cleanup.service
    - cloud-initramfs-boot-cleanup.timer
    - htop
    - vim
    - git
    - python3
    - python3-pip
    - python3-venv
    - python3-dev
    - net-tools
    - iputils-ping
    - iputils-tracepath
    - traceroute
    - dnsutils
    - nmap
    - curl
    - wget
    - lsb-release
    - software-properties-common
    - apt-transport-https
    - ca-certificates
    - gnupg
    - apt-utils
    - python3-apt
    - python3-setuptools
    - python3-pkg-resources
    - python3-requests
    - python3-urllib3
    - python3-httplib2
    - python3-oauth2client
    - python3-pycurl
    - python3-requests-oauthlib
    - python3-requests-unixsocket
    - python3-requests-toolbelt
    - python3-cryptography
    - python3-cryptography-vectors  
  apt:
    preserve_sources_list: false
    primary:
     - arches: [i386, amd64]
       uri: "http://mirrors.aliyun.com/ubuntu/"
     - arches: [default]
       uri: "http://mirrors.aliyun.com/ubuntu/"
    geoip: false
